version: "3"

tasks:
  mkdir:
    cmds:
      - mkdir -p defaults/com.apple.LaunchServices
      - mkdir -p defaults/checksum/com.apple.LaunchServices
    run: once

  dump:
    requires:
      vars: [DOMAIN]
    label: defaults:dump-{{ .DOMAIN }}
    deps:
      - mkdir
    cmds:
      - defaults export {{ .DOMAIN }} - > defaults/{{ .DOMAIN }}.plist
      - cat defaults/{{ .DOMAIN }}.plist | md5sum > defaults/checksum/{{ .DOMAIN }}.md5
    status:
      - test -f defaults/checksum/{{ .DOMAIN }}.md5 &&
        diff defaults/checksum/{{ .DOMAIN }}.md5 <(defaults export {{ .DOMAIN }} - | md5sum)

  dump-all:
    aliases: [da]
    cmds:
      - for: { var: DOMAIN, split: ", " }
        task: dump
        vars: { DOMAIN: "{{ .ITEM }}" }
      - for: { var: LAUNCH_SERVICE, split: "\n" }
        task: dump
        vars: { DOMAIN: "com.apple.LaunchServices/{{ .ITEM }}" }
    vars:
      DOMAIN:
        sh: defaults domains
      LAUNCH_SERVICE:
        sh: ls -1 ~/Library/Preferences/com.apple.LaunchServices | grep .plist | sd .plist ''
